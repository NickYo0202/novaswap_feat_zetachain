# NovaSwap 后端工作拆解

## 智能合约层（AMM/Router/LP/ETH 支持/协议费）
- 交易对合约：恒定乘积 x*y=k 兑换；手续费 0.3%；协议费开关（0.05% → 金库）；事件（兑换、添加、移除）。
- LP 代币：ERC-20；添加/移除按储备比例铸造/销毁。
  - 添加：LP_mint = LP_total * (add / reserve)。
  - 移除：tokenOut = LP_burn * reserve / LP_total。
- Router：滑点检查、最小接收量、截止时间、多跳路由（逐跳 0.3% 手续费）、余额/储备充足性检查、ETH/WETH 包装解包。
- 新池创建：任意初始比例定价；现有池添加时配比校验 amountB = amountA * (reserveB / reserveA)。
- 移除流动性：支持 0-100%；预览返还数量。
- 安全：Solidity ≥0.8；nonReentrant；检查-效果-交互；参数校验；关键操作事件。

## 链上交互服务（Node/Web3 网关）
- 钱包/网络：连接信息、网络检测、地址脱敏展示提示；支持多链网络列表（Ethereum、Arbitrum、Optimism、Polygon、BSC、Avalanche、ZetaChain）。
- 授权：检测 allowance，不足时发起 approve；双币添加需双授权。
- 交易调用：兑换/添加/移除封装 calldata，设置 deadline、amountOutMin/amountInMax，ETH↔WETH 处理。
- 余额与储备查询：多账户多代币余额、池储备；使用 Multicall 降低 RPC。
- 路由搜索：池图→直达/多跳，模拟输出择优；返回路径、预估输出、价格影响。
- 错误处理：余额不足、流动性不足、最小接收量失败、过期交易、无可用路由。
- 跨链交易编排：源链兑换→桥接→目标链兑换流水线构建与提交；跨链路径展示与估时；逐跳 0.3% 手续费应用。

## 价格与滑点/影响计算
- 兑换预估：out = (in * 0.997 * R_out) / (R_in + in * 0.997)。
- 价格影响：基于储备前后价格差计算百分比。
- 滑点与最小接收：minOut = out * (1 - slippage)；自定义滑点 >5% 标记高风险。
- 添加/移除预览：配比与预期返还数量计算。

## 索引与数据层
- 事件索引：Swap/Mint/Burn 等，含时间戳、池、数量、地址。
- 交易量与 TVL：按池聚合 24h 量，TVL（基准价源），热门代币/热门池排行。
- 历史价格：可配置时间粒度的价格序列/蜡烛。
- APY：APY = (fee24h * 365 / TVL) * 100%。
- 缓存：高频数据缓存（≤10s）；链上变更触发刷新（≤15s）。
- 跨链事件索引：源链兑换、桥接、中继、目标链兑换的事件与时间戳；存储源链/目标链 tx hash、桥接消息 id、阶段状态。
- 跨链池与 TVL：聚合多链储备与手续费收入；跨链热门池与交易量排行。
- 跨链交易历史：按交易记录跨链阶段、ETA 预估与实际耗时，支持状态回溯与重试标记。

## API 层
- 钱包/网络/余额：返回支持链、当前网络、余额列表。
- 兑换预估与路由：输入代币/数量/滑点 → 路径、预估输出、价格影响、最小接收量。
- 池列表：储备非零池；返回代币对、TVL、24h 量、APY。
- LP 持仓：用户参与池、LP 余额、份额%、可领取手续费。
- 添加/移除预览：所需配比、预期铸造 LP、返还数量。
- 历史与排行：24h 交易量、历史价格、热门代币/池查询。
- 健康检查与限流：/health；错误码与用户提示对齐。
- 跨链路由与预估：源链/目标链选择，输出、ETA、费用分解（源链 gas、桥接费、目标链 gas、跨链服务费、逐跳 0.3% 手续费）；提供“最快/最省”方案选择。
- 跨链交易状态：返回阶段（等待源链确认/跨链传输中/目标链执行中/已完成/部分完成）、两侧 tx hash、桥接进度、浏览器链接。
- 跨链费用支付：支持源链任意代币支付总费用的预估与折算，服务费上限校验，超出退回逻辑说明。
- 跨链 LP：创建/添加/移除跨链流动性预览与执行接口，支持任意链领回；显示跨链 APY 与聚合 TVL。
- 全链资产总览：多链余额汇总与法币计价，跨链发起交易时的自动网络处理提示。

## 跨链与桥接逻辑
- 支持 ZetaChain 作为跨链消息层，维护桥接资产与跨链路径配置（直接/稳定币中转多跳）。
- 路径搜索：综合输出、手续费、时间的最优路径选择；支持手动选择最快或最省钱路径；无路径时报错。
- 执行编排：源链兑换为桥接资产→跨链桥发送→目标链兑出目标代币；逐跳应用 0.3% 手续费；显示完整路径。
- ETA 估算：基于历史桥接耗时与当前网络状况估时，前端展示。

## 跨链 Gas 与费用代付
- 费用拆分：源链 gas、桥接费、目标链 gas、跨链服务费（0.05%）、第三方桥接费透传。
- 任意代币支付：源链任意支持代币折算费用；计算等值金额并扣除；支持退回超额（目标链原生资产）。
- 中继服务：在目标链代付 gas，记录服务费（≤5%），对账与结算流程。

## 跨链 LP 流动性与收益
- 跨链池创建：同资产多链池配置与部署；锁定指定链资产并铸造跨链 LP 代币。
- 跨链添加：在选择链上锁定资产，铸造跨链 LP；手续费按多链收入比例分配。
- 跨链移除：支持选择任意支持链领取资产，计算应得份额；展示跨链 APY 与聚合 TVL。

## 跨链状态追踪与断路器
- 状态机：等待源链确认→跨链传输中→目标链执行中→已完成/部分完成；失败分支退回桥接资产。
- 阶段监控：为每个阶段提供区块浏览器链接与消息 id；交易历史持久化。
- 断路器：按桥接路径的安全事件自动暂停；新跨链池每日流出限额；超过阈值暂停并告警。
- 消息验证：验证跨链消息签名与来源，使用 ZetaChain 去中心化验证机制。

## 全链资产与网络无感交互
- 多链余额聚合：连接后汇总所有支持链余额与法币价值。
- 无感发起交易：在不切换钱包网络的前提下调度跨链签名或自动提示切换；支持多链交易入口。

## 性能与可靠性
- Multicall 聚合查询，减少 RPC。兑换预估响应 ≤500ms；池数据加载 ≤3s。
- 缓存层（内存/Redis），过期≤10s；后台刷新。RPC 重试/降级、节点切换。

## 安全与合规
- 输入校验、防溢出/重入；授权最小化；转账后状态核对。
- 事件完整性（回滚处理、确认数）；治理控制协议费开关与金库地址。
- 测试：交换不变性 k、费用分配、路由边界、ETH/WETH 流、添加/移除流动性。
- 跨链安全：桥接路径断路器；跨链池每日流出限额；跨链消息签名与来源验证；ZetaChain 验证机制集成；跨链费用与服务费合规显示。

## 运维与可观测性
- 日志/指标：RPC 错误率、延迟、缓存命中、失败原因。
- 回滚处理与重新索引工具。
- 配置：多网络 RPC 与合约地址管理，热加载或重启加载。

## 前后端接口协作
- 统一 OpenAPI/Swagger 契约；错误码和提示语规范。
- CORS/认证策略（如需）；移动/桌面共用 API。
